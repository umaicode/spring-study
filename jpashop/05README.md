# ìƒí’ˆ ë„ë©”ì¸ ê°œë°œ

> JPA ìƒì† ë§¤í•‘ê³¼ ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ â€” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì—”í‹°í‹° ì•ˆì— ë‹´ëŠ” ë²•

## ğŸ“š ê°•ì˜ ì¶œì²˜

**ì¸í”„ëŸ° - ê¹€ì˜í•œì˜ "ì‹¤ì „! ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ JPA í™œìš© 1 - ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ"**

ì´ ë¬¸ì„œëŠ” ê°•ì˜ì˜ ì±•í„° 5 "ìƒí’ˆ ë„ë©”ì¸ ê°œë°œ"ì„ í•™ìŠµí•˜ë©° ì‘ì„±í•œ ë…¸íŠ¸ì…ë‹ˆë‹¤.
ì±•í„° 4ì˜ íšŒì› ë„ë©”ì¸ì—ì„œ ìµíŒ ê³„ì¸µí˜• ì•„í‚¤í…ì²˜(Repository â†’ Service)ë¥¼ ê·¸ëŒ€ë¡œ ì´ì–´ê°€ë˜,
**JPA ìƒì† ë§¤í•‘**ê³¼ **ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´(ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì—”í‹°í‹° ë‚´ë¶€ì— ë°°ì¹˜)** ì´ë¼ëŠ” ë‘ ê°€ì§€ í•µì‹¬ ê°œë…ì´ ìƒˆë¡­ê²Œ ì¶”ê°€ë©ë‹ˆë‹¤.

| ì±•í„° | ë‚´ìš© |
|------|------|
| ì±•í„° 4 (ì´ì „) | íšŒì› ë„ë©”ì¸ ê°œë°œ â€” Repository, Service, Test êµ¬í˜„ |
| **ì±•í„° 5 (í˜„ì¬)** | **ìƒí’ˆ ë„ë©”ì¸ ê°œë°œ â€” JPA ìƒì† ë§¤í•‘, ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´, persist vs merge** |
| ì±•í„° 6 (ë‹¤ìŒ) | ì£¼ë¬¸ ë„ë©”ì¸ ê°œë°œ â€” ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì„œë“œ, ì£¼ë¬¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ |

---

## ğŸ¯ í•™ìŠµ ëª©í‘œ

ì´ ë¬¸ì„œë¥¼ í†µí•´ ë‹¤ìŒì„ ì´í•´í•˜ê³  ì‹¤ìŠµí•©ë‹ˆë‹¤:

1. **JPA ìƒì† ë§¤í•‘ 3ê°€ì§€ ì „ëµ ë¹„êµ** â€” `JOINED` / `SINGLE_TABLE` / `TABLE_PER_CLASS` ê°ê°ì˜ ì¥ë‹¨ì ê³¼ ì„ íƒ ê¸°ì¤€
2. **`@DiscriminatorColumn` / `@DiscriminatorValue` ì—­í• ** â€” SINGLE_TABLE ì „ëµì—ì„œ êµ¬ë¶„ ì»¬ëŸ¼ì´ ì‘ë™í•˜ëŠ” ë°©ì‹
3. **ì¶”ìƒ í´ë˜ìŠ¤ë¡œ ìƒìœ„ ì—”í‹°í‹° ì„¤ê³„** â€” ê³µí†µ í•„ë“œë¥¼ Item ì¶”ìƒ í´ë˜ìŠ¤ì— ì§‘ì¤‘ì‹œí‚¤ëŠ” ì´ìœ 
4. **ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ vs íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´** â€” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ„ì¹˜ ì„ íƒì˜ ê·¼ê±°
5. **ì»¤ìŠ¤í…€ ì˜ˆì™¸ ì„¤ê³„** â€” `RuntimeException` ìƒì†ê³¼ ìƒì„±ì ì˜¤ë²„ë¡œë”©ì˜ ì˜ë¯¸
6. **`em.persist()` vs `em.merge()` ë¶„ê¸°** â€” ì‹ ê·œ/ê¸°ì¡´ ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ëŠ” ë‘ ê°€ì§€ ê²½ë¡œ

---

## ğŸ—ºï¸ í•™ìŠµ ë¡œë“œë§µ

ì±•í„° 5ëŠ” **ê³„ì¸µë³„ Bottom-Up** ë°©ì‹ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
ë„ë©”ì¸(ì—”í‹°í‹°) ì„¤ê³„ì™€ ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ë¨¼ì € ì™„ì„±í•œ ë’¤, Repositoryì™€ Serviceë¥¼ ì°¨ë¡€ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.

```
1ë‹¨ê³„: ìƒí’ˆ ì—”í‹°í‹° ê°œë°œ (Item / Book / Album / Movie)
   - Item ì¶”ìƒ í´ë˜ìŠ¤: ê³µí†µ í•„ë“œ + ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ
   - SINGLE_TABLE ìƒì† ì „ëµ ì ìš©
   - @DiscriminatorColumn / @DiscriminatorValue
   - addStock() / removeStock() ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
   â†“
2ë‹¨ê³„: ì»¤ìŠ¤í…€ ì˜ˆì™¸ ê°œë°œ (NotEnoughStockException)
   - RuntimeException ìƒì† ì´ìœ 
   - ìƒì„±ì ì˜¤ë²„ë¡œë”© 4ê°€ì§€
   â†“
3ë‹¨ê³„: ìƒí’ˆ ë¦¬í¬ì§€í† ë¦¬ ê°œë°œ (ItemRepository)
   - persist vs merge ë¶„ê¸° ë¡œì§
   - findOne / findAll
   â†“
4ë‹¨ê³„: ìƒí’ˆ ì„œë¹„ìŠ¤ ê°œë°œ (ItemService)
   - ì±•í„° 4 MemberServiceì™€ ë™ì¼í•œ íŠ¸ëœì­ì…˜ ì „ëµ
   - ì„œë¹„ìŠ¤ëŠ” íŠ¸ëœì­ì…˜ + ìœ„ì„ ì—­í• ë§Œ ë‹´ë‹¹
```

**ì™œ ì´ ìˆœì„œì¸ê°€?**
- **ì—”í‹°í‹° ìš°ì„ **: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì—”í‹°í‹° ì•ˆì— ìˆìœ¼ë¯€ë¡œ, RepositoryÂ·Serviceë³´ë‹¤ ì—”í‹°í‹°ë¥¼ ë¨¼ì € ì™„ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
- **ì˜ˆì™¸ ì˜ì¡´**: `removeStock()`ì´ `NotEnoughStockException`ì„ ë˜ì§€ë¯€ë¡œ, ì˜ˆì™¸ í´ë˜ìŠ¤ê°€ ì—”í‹°í‹°ë³´ë‹¤ ë¨¼ì € ë˜ëŠ” ë™ì‹œì— ì •ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

---

## ğŸ“– ëª©ì°¨

1. [ìƒí’ˆ ì—”í‹°í‹° ê°œë°œ](#1-ìƒí’ˆ-ì—”í‹°í‹°-ê°œë°œ)
   - 1.1 ìƒí’ˆ ê³„ì¸µ êµ¬ì¡° ì„¤ê³„
   - 1.2 JPA ìƒì† ë§¤í•‘ 3ê°€ì§€ ì „ëµ ë¹„êµ
   - 1.3 SINGLE_TABLE ì „ëµ ì„ íƒ ì´ìœ 
   - 1.4 `@DiscriminatorColumn` / `@DiscriminatorValue` ì—­í• 
   - 1.5 Item ì—”í‹°í‹° ì „ì²´ ì½”ë“œ
   - 1.6 Book / Album / Movie êµ¬í˜„ì²´ ì½”ë“œ
2. [ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ â€” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì—”í‹°í‹° ì•ˆì—](#2-ë„ë©”ì¸-ëª¨ë¸-íŒ¨í„´--ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§ì„-ì—”í‹°í‹°-ì•ˆì—)
   - 2.1 ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ vs íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´
   - 2.2 `addStock()` êµ¬í˜„
   - 2.3 `removeStock()` êµ¬í˜„
   - 2.4 ì™œ Setter ëŒ€ì‹  ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œì¸ê°€
3. [NotEnoughStockException â€” ì»¤ìŠ¤í…€ ì˜ˆì™¸](#3-notenoughstockexception--ì»¤ìŠ¤í…€-ì˜ˆì™¸)
   - 3.1 `RuntimeException` ìƒì† ì„ íƒ ì´ìœ 
   - 3.2 ìƒì„±ì ì˜¤ë²„ë¡œë”© 4ê°€ì§€ ì´ìœ 
   - 3.3 ì „ì²´ ì½”ë“œ
4. [ìƒí’ˆ ë¦¬í¬ì§€í† ë¦¬ ê°œë°œ](#4-ìƒí’ˆ-ë¦¬í¬ì§€í† ë¦¬-ê°œë°œ)
   - 4.1 `ItemRepository` ì „ì²´ ì½”ë“œ
   - 4.2 `persist` vs `merge` ë¶„ê¸° ë¡œì§
   - 4.3 `em.merge()` ê°œìš”
5. [ìƒí’ˆ ì„œë¹„ìŠ¤ ê°œë°œ](#5-ìƒí’ˆ-ì„œë¹„ìŠ¤-ê°œë°œ)
   - 5.1 `ItemService` ì „ì²´ ì½”ë“œ
   - 5.2 ì±•í„° 4 `MemberService`ì™€ì˜ íŒ¨í„´ ë¹„êµ
6. [Best Practice ë° ì£¼ì˜ì‚¬í•­](#6-best-practice-ë°-ì£¼ì˜ì‚¬í•­)
7. [ë¶€ë¡](#7-ë¶€ë¡)

---

## 1. ìƒí’ˆ ì—”í‹°í‹° ê°œë°œ

### 1.1 ìƒí’ˆ ê³„ì¸µ êµ¬ì¡° ì„¤ê³„

ì‡¼í•‘ëª°ì˜ ìƒí’ˆì€ **ì±…(Book)**, **ìŒë°˜(Album)**, **ì˜í™”(Movie)** ë¼ëŠ” ì„¸ ê°€ì§€ êµ¬ì²´ì ì¸ íƒ€ì…ìœ¼ë¡œ ë‚˜ë‰©ë‹ˆë‹¤.
ì„¸ íƒ€ì…ì€ `name`, `price`, `stockQuantity` ë“±ì˜ **ê³µí†µ ì†ì„±**ì„ ê³µìœ í•˜ë©´ì„œ, ê°ì ê³ ìœ í•œ ì†ì„±(author, artist, director ë“±)ì„ ì¶”ê°€ë¡œ ê°–ìŠµë‹ˆë‹¤.

ì´ ìƒí™©ì€ ê°ì²´ì§€í–¥ì˜ **ìƒì† ê´€ê³„**ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„ë©ë‹ˆë‹¤.

```
Item (ì¶”ìƒ í´ë˜ìŠ¤)
â”œâ”€â”€ Book   â€” author, isbn
â”œâ”€â”€ Album  â€” artist, etc
â””â”€â”€ Movie  â€” director, actor
```

`Item`ì„ **ì¶”ìƒ í´ë˜ìŠ¤(abstract class)** ë¡œ ë§Œë“œëŠ” ì´ìœ ëŠ”, `Item` ìì²´ëŠ” ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”ë  ì¼ì´ ì—†ê³ ,
ë°˜ë“œì‹œ `Book`, `Album`, `Movie` ì¤‘ í•˜ë‚˜ì˜ êµ¬ì²´ì ì¸ íƒ€ì…ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

---

### 1.2 JPA ìƒì† ë§¤í•‘ 3ê°€ì§€ ì „ëµ ë¹„êµ

ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ëŠ” ìƒì† ê°œë…ì´ ì—†ìŠµë‹ˆë‹¤.
JPAëŠ” ê°ì²´ì˜ ìƒì† ê´€ê³„ë¥¼ DB í…Œì´ë¸”ì— ë§¤í•‘í•˜ê¸° ìœ„í•´ 3ê°€ì§€ ì „ëµì„ ì œê³µí•©ë‹ˆë‹¤.

| ì „ëµ | ì–´ë…¸í…Œì´ì…˜ | ì„¤ëª… | ì¥ì  | ë‹¨ì  |
|------|-----------|------|------|------|
| **JOINED** | `InheritanceType.JOINED` | ê³µí†µ ì»¬ëŸ¼ì€ ë¶€ëª¨ í…Œì´ë¸”, ìì‹ë³„ ë³„ë„ í…Œì´ë¸”ë¡œ ë¶„ë¦¬ | ì •ê·œí™”, ì™¸ë˜í‚¤ ë¬´ê²°ì„± ìœ ì§€ | JOIN ì¿¼ë¦¬ ë°œìƒ, êµ¬ì¡° ë³µì¡ |
| **SINGLE_TABLE** | `InheritanceType.SINGLE_TABLE` | ëª¨ë“  ìì‹ ì»¬ëŸ¼ì„ í•˜ë‚˜ì˜ í…Œì´ë¸”ì— í†µí•© | ì¡°íšŒ ì„±ëŠ¥ ìµœê³ , êµ¬ì¡° ë‹¨ìˆœ | NULL ì»¬ëŸ¼ ë‹¤ìˆ˜ ë°œìƒ |
| **TABLE_PER_CLASS** | `InheritanceType.TABLE_PER_CLASS` | ìì‹ë§ˆë‹¤ ë…ë¦½ëœ í…Œì´ë¸” ìƒì„± (ë¶€ëª¨ ì»¬ëŸ¼ ë³µì œ) | ì„œë¸Œíƒ€ì…ë³„ ë…ë¦½ ê´€ë¦¬ | UNION ì¿¼ë¦¬ í•„ìš”, ì„±ëŠ¥ ì €í•˜ |

---

### 1.3 SINGLE_TABLE ì „ëµ ì„ íƒ ì´ìœ 

ê°•ì˜ì—ì„œëŠ” **SINGLE_TABLE** ì „ëµì„ ì„ íƒí•©ë‹ˆë‹¤.

SINGLE_TABLE ì „ëµì„ ì‚¬ìš©í•˜ë©´ DBì—ëŠ” ë‹¨ í•˜ë‚˜ì˜ `ITEM` í…Œì´ë¸”ë§Œ ìƒì„±ë©ë‹ˆë‹¤.
Book, Album, Movieì˜ ëª¨ë“  ì»¬ëŸ¼ì´ í•©ì³ì§€ê³ , `dtype` ì´ë¼ëŠ” êµ¬ë¶„ ì»¬ëŸ¼ìœ¼ë¡œ ì–´ë–¤ íƒ€ì…ì¸ì§€ ì‹ë³„í•©ë‹ˆë‹¤.

```
ITEM í…Œì´ë¸” (SINGLE_TABLE ì „ëµ ê²°ê³¼)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ item_id â”‚ dtype â”‚     name     â”‚ price  â”‚ stockQuantity â”‚ author â”‚ isbn â”‚ artist â”‚ etc  â”‚ director â”‚ actor â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    1    â”‚   B   â”‚ ìë°” ORM JPA â”‚ 30000  â”‚      100      â”‚ ê¹€ì˜í•œ  â”‚ ...  â”‚  null  â”‚ null â”‚   null   â”‚ null  â”‚
â”‚    2    â”‚   A   â”‚  BTS ì•¨ë²”    â”‚ 15000  â”‚       50      â”‚  null  â”‚ null â”‚  BTS   â”‚ ...  â”‚   null   â”‚ null  â”‚
â”‚    3    â”‚   M   â”‚  ê¸°ìƒì¶©      â”‚  5000  â”‚      200      â”‚  null  â”‚ null â”‚  null  â”‚ null â”‚  ë´‰ì¤€í˜¸   â”‚ ì†¡ê°•í˜¸  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
```

**SINGLE_TABLE ì„ íƒ ì´ìœ :**
- ì¡°íšŒ ì‹œ JOIN ì—†ì´ ë‹¨ì¼ í…Œì´ë¸” SELECT â†’ **ì¡°íšŒ ì„±ëŠ¥ì´ ê°€ì¥ ë›°ì–´ë‚¨**
- í…Œì´ë¸” êµ¬ì¡°ê°€ ë‹¨ìˆœí•´ **ê°œë°œ ë° ìœ ì§€ë³´ìˆ˜ê°€ ì‰¬ì›€**
- ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ ê·œëª¨ì—ì„œëŠ” NULL ì»¬ëŸ¼ì˜ ë‹¨ì ë³´ë‹¤ ì„±ëŠ¥Â·ë‹¨ìˆœì„±ì´ ë” ì¤‘ìš”

---

### 1.4 `@DiscriminatorColumn` / `@DiscriminatorValue` ì—­í• 

SINGLE_TABLE ì „ëµì—ì„œëŠ” í•˜ë‚˜ì˜ í…Œì´ë¸” ì•ˆì— ì—¬ëŸ¬ íƒ€ì…ì˜ ë°ì´í„°ê°€ ì„ì—¬ ìˆìŠµë‹ˆë‹¤.
JPAê°€ ì–´ë–¤ í–‰ì´ Bookì¸ì§€, Albumì¸ì§€ êµ¬ë¶„í•˜ë ¤ë©´ **êµ¬ë¶„ ì»¬ëŸ¼(Discriminator Column)** ì´ í•„ìš”í•©ë‹ˆë‹¤.

```java
// ë¶€ëª¨ ì—”í‹°í‹°: êµ¬ë¶„ ì»¬ëŸ¼ ì§€ì •
@DiscriminatorColumn(name = "dtype")
// â†’ DB í…Œì´ë¸”ì— "dtype" ì»¬ëŸ¼ì´ ìƒì„±ë¨

// ìì‹ ì—”í‹°í‹°: ê°ìì˜ êµ¬ë¶„ê°’ ì§€ì •
@DiscriminatorValue("B")   // Book  â†’ dtype = 'B'
@DiscriminatorValue("A")   // Album â†’ dtype = 'A'
@DiscriminatorValue("M")   // Movie â†’ dtype = 'M'
```

| ì–´ë…¸í…Œì´ì…˜ | ìœ„ì¹˜ | ì—­í•  |
|------------|------|------|
| `@DiscriminatorColumn(name = "dtype")` | ë¶€ëª¨ ì—”í‹°í‹° | DB í…Œì´ë¸”ì— dtype ì»¬ëŸ¼ì„ ìƒì„±í•˜ë„ë¡ JPAì— ì§€ì‹œ |
| `@DiscriminatorValue("B")` | ìì‹ ì—”í‹°í‹° | ì´ íƒ€ì…ì˜ í–‰ì€ dtype = 'B' ë¡œ ì €ì¥/ì¡°íšŒ |

> `@DiscriminatorColumn` ì˜ `name` ì†ì„±ì„ ìƒëµí•˜ë©´ ê¸°ë³¸ê°’ `"DTYPE"` (ëŒ€ë¬¸ì)ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.
> ê°•ì˜ì—ì„œëŠ” `"dtype"` (ì†Œë¬¸ì)ë¡œ ëª…ì‹œí•©ë‹ˆë‹¤.

---

### 1.5 Item ì—”í‹°í‹° ì „ì²´ ì½”ë“œ

```java
package jpabook.jpashop.domain.Item;

import jakarta.persistence.*;
import jpabook.jpashop.domain.Category;
import jpabook.jpashop.exception.NotEnoughStockException;
import lombok.Getter;
import lombok.Setter;

import java.util.ArrayList;
import java.util.List;

@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn(name = "dtype")
@Getter @Setter
public abstract class Item {

    @Id @GeneratedValue
    @Column(name = "item_id")
    private Long id;

    private String name;
    private int price;
    private int stockQuantity;

    @ManyToMany(mappedBy = "items")
    private List<Category> categories = new ArrayList<>();

    // === ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ === //

    /**
     * stock ì¦ê°€
     */
    public void addStock(int quantity) {
        this.stockQuantity += quantity;
    }

    /**
     * stock ê°ì†Œ
     */
    public void removeStock(int quantity) {
        int restStock = this.stockQuantity - quantity;
        if (restStock < 0) {
            throw new NotEnoughStockException("need more stock");
        }
        this.stockQuantity = restStock;
    }
}
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- `abstract` í‚¤ì›Œë“œë¡œ ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™” ë¶ˆê°€ â†’ Book/Album/Movieë¥¼ í†µí•´ì„œë§Œ ìƒì„±
- `@Inheritance(strategy = InheritanceType.SINGLE_TABLE)` â†’ ë‹¨ì¼ í…Œì´ë¸” ì „ëµ ì„ íƒ
- `@DiscriminatorColumn(name = "dtype")` â†’ êµ¬ë¶„ ì»¬ëŸ¼ ì§€ì •
- ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ(`addStock`, `removeStock`)ë¥¼ ì—”í‹°í‹° ë‚´ë¶€ì— ë°°ì¹˜ â†’ ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´

---

### 1.6 Book / Album / Movie êµ¬í˜„ì²´ ì½”ë“œ

**Book.java**

```java
package jpabook.jpashop.domain.Item;

import jakarta.persistence.DiscriminatorValue;
import jakarta.persistence.Entity;
import lombok.Getter;
import lombok.Setter;

@Entity
@DiscriminatorValue("B")
@Getter @Setter
public class Book extends Item {

    private String author;
    private String isbn;
}
```

**Album.java**

```java
package jpabook.jpashop.domain.Item;

import jakarta.persistence.DiscriminatorValue;
import jakarta.persistence.Entity;
import lombok.Getter;
import lombok.Setter;

@Entity
@DiscriminatorValue("A")
@Getter @Setter
public class Album extends Item {

    private String artist;
    private String etc;
}
```

**Movie.java**

```java
package jpabook.jpashop.domain.Item;

import jakarta.persistence.DiscriminatorValue;
import jakarta.persistence.Entity;
import lombok.Getter;
import lombok.Setter;

@Entity
@DiscriminatorValue("M")
@Getter @Setter
public class Movie extends Item {

    private String director;
    private String actor;
}
```

ì„¸ ìì‹ í´ë˜ìŠ¤ ëª¨ë‘ êµ¬ì¡°ê°€ ë™ì¼í•©ë‹ˆë‹¤:
- `@DiscriminatorValue`ë¡œ ìì‹ ì˜ êµ¬ë¶„ê°’ ì„ ì–¸
- `extends Item`ìœ¼ë¡œ ê³µí†µ í•„ë“œ(id, name, price, stockQuantity)ë¥¼ ìë™ ìƒì†
- ìì‹ ë§Œì˜ ê³ ìœ  í•„ë“œ ì¶”ê°€

---

## 2. ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ â€” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì—”í‹°í‹° ì•ˆì—

### 2.1 ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ vs íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´

ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ **ì–´ë””ì— ìœ„ì¹˜ì‹œí‚¬ ê²ƒì¸ê°€**ëŠ” ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ ì„ íƒì…ë‹ˆë‹¤.

| êµ¬ë¶„ | ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ | íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´ |
|------|----------------|---------------------|
| ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ„ì¹˜ | **ì—”í‹°í‹°(ë„ë©”ì¸) ë‚´ë¶€** | **ì„œë¹„ìŠ¤ ê³„ì¸µ** |
| íŠ¹ì§• | ê°ì²´ ì§€í–¥ì  â€” ì—”í‹°í‹°ê°€ ë°ì´í„° + ë¡œì§ì„ í•¨ê»˜ ë³´ìœ  | ì ˆì°¨ì  â€” ì„œë¹„ìŠ¤ê°€ ë°ì´í„°ë¥¼ êº¼ë‚´ ë¡œì§ì„ ì²˜ë¦¬ |
| JPA ê¶í•© | ì¢‹ìŒ (ì—”í‹°í‹°ê°€ ì‚´ì•„ìˆëŠ” ê°ì²´ë¡œ ë™ì‘) | ë³´í†µ (ì—”í‹°í‹°ë¥¼ ë‹¨ìˆœ DTOì²˜ëŸ¼ ì·¨ê¸‰) |
| ì¥ì  | ì‘ì§‘ë„ ë†’ìŒ, ì™¸ë¶€ì—ì„œ ë‚´ë¶€ ìƒíƒœ ì¡°ì‘ ë¶ˆê°€ | ë‹¨ìˆœ CRUDì—ì„œ ì´í•´í•˜ê¸° ì‰¬ì›€ |
| ë‹¨ì  | ë„ë©”ì¸ ì„¤ê³„ ì—­ëŸ‰ í•„ìš” | ì„œë¹„ìŠ¤ ê³„ì¸µì´ ë¹„ëŒ€í•´ì§, ì—”í‹°í‹°ëŠ” ë°ì´í„° ìº¡ìŠ |

ê°•ì˜ì—ì„œëŠ” **ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´**ì„ ì±„íƒí•©ë‹ˆë‹¤.
JPAì—ì„œ ì—”í‹°í‹°ëŠ” ë‹¨ìˆœí•œ ë°ì´í„° ì»¨í…Œì´ë„ˆê°€ ì•„ë‹Œ **ì‚´ì•„ìˆëŠ” ê°ì²´**ì´ë¯€ë¡œ,
í•´ë‹¹ ë°ì´í„°ë¥¼ ê°€ì¥ ì˜ ì•„ëŠ” ì—”í‹°í‹° ìì‹ ì´ ê´€ë ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°–ëŠ” ê²ƒì´ ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.

---

### 2.2 `addStock()` êµ¬í˜„

```java
/**
 * stock ì¦ê°€
 */
public void addStock(int quantity) {
    this.stockQuantity += quantity;
}
```

ì¬ê³ ë¥¼ ëŠ˜ë¦¬ëŠ” ë‹¨ìˆœí•œ ì—°ì‚°ì…ë‹ˆë‹¤.
ë°˜í™˜ ì¡°ê±´ ê²€ì¦ì´ ë¶ˆí•„ìš”í•˜ë¯€ë¡œ ë‹¨ìˆœí•˜ê²Œ êµ¬í˜„í•©ë‹ˆë‹¤.
ìƒí’ˆ ë°˜í’ˆ ì‹œ í˜¸ì¶œë˜ì–´ ì¬ê³ ë¥¼ ë³µêµ¬í•˜ëŠ” ìš©ë„ë¡œë„ ì‚¬ìš©ë©ë‹ˆë‹¤.

---

### 2.3 `removeStock()` êµ¬í˜„

```java
/**
 * stock ê°ì†Œ
 */
public void removeStock(int quantity) {
    int restStock = this.stockQuantity - quantity;
    if (restStock < 0) {
        throw new NotEnoughStockException("need more stock");
    }
    this.stockQuantity = restStock;
}
```

ì¬ê³  ê°ì†Œ ì‹œ **ìŒìˆ˜ ë°©ì§€ ê²€ì¦ ë¡œì§**ì´ í¬í•¨ë©ë‹ˆë‹¤.

ì‹¤í–‰ íë¦„:
1. ì°¨ê° í›„ ì”ì—¬ ì¬ê³ (`restStock`)ë¥¼ ë¨¼ì € ê³„ì‚°
2. ì”ì—¬ ì¬ê³ ê°€ ìŒìˆ˜ë©´ `NotEnoughStockException` ë°œìƒ
3. ê²€ì¦ í†µê³¼ ì‹œ `stockQuantity` ì—…ë°ì´íŠ¸

> ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ë¥¼ ë˜ì§€ê¸° ë•Œë¬¸ì—, í˜¸ì¶œìëŠ” ë³„ë„ë¡œ ì¬ê³  ìŒìˆ˜ ì—¬ë¶€ë¥¼ í™•ì¸í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

---

### 2.4 ì™œ Setter ëŒ€ì‹  ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œì¸ê°€

`Item`ì—ëŠ” `@Setter`ê°€ ìˆì–´ ì™¸ë¶€ì—ì„œ `setStockQuantity()`ë¥¼ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê·¸ëŸ¼ì—ë„ ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ(`addStock`, `removeStock`)ë¥¼ ë³„ë„ë¡œ ë§Œë“  ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?

```java
// ë‚˜ìœ ë°©ì‹ â€” Setter ì§ì ‘ ì‚¬ìš© (ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ê³„ì‚°)
item.setStockQuantity(item.getStockQuantity() - quantity);
// ë¬¸ì œì  1: ìŒìˆ˜ ê²€ì¦ ë¡œì§ì´ ì—†ìŒ â†’ ì¬ê³ ê°€ -1ì´ ë  ìˆ˜ ìˆìŒ
// ë¬¸ì œì  2: ë™ì¼í•œ ê³„ì‚° ì½”ë“œê°€ ì—¬ëŸ¬ ê³³ì— ì¤‘ë³µë  ìˆ˜ ìˆìŒ

// ì¢‹ì€ ë°©ì‹ â€” ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ í˜¸ì¶œ (ê²€ì¦ í¬í•¨)
item.removeStock(quantity);
// ì¥ì  1: ê²€ì¦ ë¡œì§ì´ ì—”í‹°í‹° ë‚´ë¶€ì— ìº¡ìŠí™”ë¨
// ì¥ì  2: í˜¸ì¶œí•˜ëŠ” ëª¨ë“  ê³³ì—ì„œ ì¼ê´€ì„± ë³´ì¥
```

í•µì‹¬ ì›ì¹™: **ë°ì´í„°ë¥¼ ì†Œìœ í•œ ê°ì²´ê°€ ê·¸ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ë¡œì§ë„ ì±…ì„ì§„ë‹¤.**

---

## 3. NotEnoughStockException â€” ì»¤ìŠ¤í…€ ì˜ˆì™¸

### 3.1 `RuntimeException` ìƒì† ì„ íƒ ì´ìœ 

ìë°” ì˜ˆì™¸ëŠ” í¬ê²Œ ë‘ ì¢…ë¥˜ì…ë‹ˆë‹¤:

| ë¶„ë¥˜ | ì˜ˆì‹œ | íŠ¹ì§• |
|------|------|------|
| **Checked Exception** | `IOException`, `SQLException` | ì»´íŒŒì¼ëŸ¬ê°€ ì²˜ë¦¬ ê°•ì œ â†’ try-catch ë˜ëŠ” throws í•„ìˆ˜ |
| **Unchecked Exception** (RuntimeException) | `NullPointerException`, `IllegalArgumentException` | ì²˜ë¦¬ ì—¬ë¶€ëŠ” í˜¸ì¶œìê°€ ì„ íƒ |

`NotEnoughStockException`ì„ `RuntimeException`ìœ¼ë¡œ ë§Œë“œëŠ” ì´ìœ :
1. **ìŠ¤í”„ë§ `@Transactional` ë¡¤ë°± ê¸°ë³¸ ëŒ€ìƒ** â€” `RuntimeException` ë°œìƒ ì‹œ íŠ¸ëœì­ì…˜ì´ ìë™ìœ¼ë¡œ ë¡¤ë°±ë¨
2. **ë¶ˆí•„ìš”í•œ try-catch ì œê±°** â€” ì¬ê³  ë¶€ì¡±ì€ ë§¤ìš° ë“œë¬¸ ìƒí™©ì´ë¯€ë¡œ, ëª¨ë“  í˜¸ì¶œ ì§€ì ì— try-catchë¥¼ ê°•ì œí•˜ëŠ” ê²ƒì€ ì½”ë“œë¥¼ ì¥í™©í•˜ê²Œ ë§Œë“¦
3. **ìŠ¤í”„ë§ ì˜ˆì™¸ ì²˜ë¦¬ ì² í•™** â€” ìŠ¤í”„ë§ì€ ì¸í”„ë¼ ì˜ˆì™¸ë¥¼ `RuntimeException`ìœ¼ë¡œ ë˜í•‘í•˜ëŠ” ì •ì±…ì„ ì¼ê´€ë˜ê²Œ ì‚¬ìš©

---

### 3.2 ìƒì„±ì ì˜¤ë²„ë¡œë”© 4ê°€ì§€ ì´ìœ 

```java
public NotEnoughStockException()                              // ê¸°ë³¸
public NotEnoughStockException(String message)                // ë©”ì‹œì§€ í¬í•¨
public NotEnoughStockException(String message, Throwable cause) // ë©”ì‹œì§€ + ê·¼ì› ì˜ˆì™¸
public NotEnoughStockException(Throwable cause)               // ê·¼ì› ì˜ˆì™¸ë§Œ
```

4ê°€ì§€ë¥¼ ëª¨ë‘ ì˜¤ë²„ë¡œë”©í•˜ëŠ” ì´ìœ :

| ìƒì„±ì | ì‚¬ìš© ìƒí™© |
|--------|---------|
| `()` | ë‹¨ìˆœ ì¬ê³  ë¶€ì¡± â€” ì¶”ê°€ ì •ë³´ê°€ ë¶ˆí•„ìš”í•  ë•Œ |
| `(String message)` | ì¬ê³  ë¶€ì¡± ì›ì¸ì„ ë©”ì‹œì§€ë¡œ ì„¤ëª…í•  ë•Œ (`"need more stock"`) |
| `(String message, Throwable cause)` | ë‹¤ë¥¸ ì˜ˆì™¸ê°€ ì›ì¸ì¼ ë•Œ â€” ê·¼ì› ì˜ˆì™¸ë¥¼ ì²´ì´ë‹í•˜ì—¬ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ìœ ì§€ |
| `(Throwable cause)` | ë©”ì‹œì§€ëŠ” ë¶ˆí•„ìš”í•˜ê³  ê·¼ì› ì˜ˆì™¸ë§Œ ì „ë‹¬í•  ë•Œ |

> **ì˜ˆì™¸ ì²´ì´ë‹(Exception Chaining)**: `cause`ë¥¼ í¬í•¨í•˜ë©´ ë¡œê·¸ì—ì„œ ì›ë˜ ì˜ˆì™¸ì˜ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ê¹Œì§€ í™•ì¸í•  ìˆ˜ ìˆì–´ ë””ë²„ê¹…ì´ ìš©ì´í•©ë‹ˆë‹¤.

---

### 3.3 ì „ì²´ ì½”ë“œ

```java
package jpabook.jpashop.exception;

public class NotEnoughStockException extends RuntimeException {

    public NotEnoughStockException() {
        super();
    }

    public NotEnoughStockException(String message) {
        super(message);
    }

    public NotEnoughStockException(String message, Throwable cause) {
        super(message, cause);
    }

    public NotEnoughStockException(Throwable cause) {
        super(cause);
    }
}
```

---

## 4. ìƒí’ˆ ë¦¬í¬ì§€í† ë¦¬ ê°œë°œ

### 4.1 ItemRepository ì „ì²´ ì½”ë“œ

```java
package jpabook.jpashop.repository;

import jakarta.persistence.EntityManager;
import jpabook.jpashop.domain.Item.Item;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@RequiredArgsConstructor
public class ItemRepository {

    private final EntityManager em;

    public void save(Item item) {
        if (item.getId() == null) {
            em.persist(item);
        } else {
            em.merge(item);
        }
    }

    public Item findOne(Long id) {
        return em.find(Item.class, id);
    }

    public List<Item> findAll() {
        return em.createQuery("select i from Item i", Item.class)
                .getResultList();
    }
}
```

---

### 4.2 `persist` vs `merge` ë¶„ê¸° ë¡œì§

`save()` ë©”ì„œë“œì˜ í•µì‹¬ì€ **ì—”í‹°í‹°ì˜ ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ JPA ë©”ì„œë“œë¥¼ í˜¸ì¶œ**í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.

```java
public void save(Item item) {
    if (item.getId() == null) {
        em.persist(item);   // ì‹ ê·œ ì—”í‹°í‹° â†’ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡
    } else {
        em.merge(item);     // ê¸°ì¡´ ì—”í‹°í‹° â†’ ë³‘í•©
    }
}
```

| ì¡°ê±´ | í˜¸ì¶œ ë©”ì„œë“œ | ì˜ë¯¸ |
|------|-----------|------|
| `item.getId() == null` (ìƒˆ ìƒí’ˆ) | `em.persist(item)` | ì™„ì „íˆ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì‹ ê·œ ë“±ë¡ â†’ INSERT ì¿¼ë¦¬ ë°œìƒ |
| `item.getId() != null` (ê¸°ì¡´ ìƒí’ˆ) | `em.merge(item)` | DBì— ì´ë¯¸ ì €ì¥ëœ ìƒí’ˆì˜ ë°ì´í„°ë¥¼ ê°±ì‹  â†’ UPDATE ì¿¼ë¦¬ ë°œìƒ |

**ì™œ `em.persist()`ëŠ” idê°€ nullì¼ ë•Œë§Œ í˜¸ì¶œí•˜ë‚˜?**

ì²˜ìŒ `new Item()`ìœ¼ë¡œ ìƒì„±í•œ ê°ì²´ëŠ” ì•„ì§ DBì— ì €ì¥ë˜ì§€ ì•Šì•„ `id`ê°€ `null`ì…ë‹ˆë‹¤.
ì´ ê²½ìš° `em.persist()`ë¥¼ í˜¸ì¶œí•˜ë©´ JPAê°€ `id`ë¥¼ ìƒì„±í•˜ê³ (`@GeneratedValue`) ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡í•©ë‹ˆë‹¤.

ë°˜ëŒ€ë¡œ ì´ë¯¸ DBì— ì €ì¥ëœ ìƒí’ˆì˜ `id`ëŠ” ê°’ì´ ìˆìœ¼ë¯€ë¡œ `em.merge()`ë¡œ ê¸°ì¡´ ë°ì´í„°ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.

---

### 4.3 `em.merge()` ê°œìš”

`em.merge()`ëŠ” **ì¤€ì˜ì†(detached) ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³‘í•©**í•˜ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤.

í˜„ì¬ëŠ” "idê°€ ìˆìœ¼ë©´ merge"ë¼ê³ ë§Œ ì´í•´í•˜ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.

> `em.merge()`ì˜ ìƒì„¸ ë™ì‘ ì›ë¦¬(ì¤€ì˜ì† ì—”í‹°í‹°ë€ ë¬´ì—‡ì¸ì§€, ë³€ê²½ ê°ì§€ vs mergeì˜ ì°¨ì´)ëŠ”
> **ì±•í„° 7 ì›¹ ê³„ì¸µ ê°œë°œ**ì—ì„œ ìƒí’ˆ ìˆ˜ì • ê¸°ëŠ¥ì„ êµ¬í˜„í•  ë•Œ ìì„¸íˆ ë‹¤ë£¹ë‹ˆë‹¤.
> ì§€ê¸ˆì€ "ì‹ ê·œ ì €ì¥ì€ persist, ê¸°ì¡´ ê°±ì‹ ì€ merge"ë¼ê³  ì´í•´í•˜ê³  ë„˜ì–´ê°‘ë‹ˆë‹¤.

---

## 5. ìƒí’ˆ ì„œë¹„ìŠ¤ ê°œë°œ

### 5.1 ItemService ì „ì²´ ì½”ë“œ

```java
package jpabook.jpashop.service;

import jpabook.jpashop.domain.Item.Item;
import jpabook.jpashop.repository.ItemRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class ItemService {

    private final ItemRepository itemRepository;

    @Transactional
    public void saveItem(Item item) {
        itemRepository.save(item);
    }

    public List<Item> findItems() {
        return itemRepository.findAll();
    }

    public Item findOne(Long itemId) {
        return itemRepository.findOne(itemId);
    }
}
```

---

### 5.2 ì±•í„° 4 `MemberService`ì™€ì˜ íŒ¨í„´ ë¹„êµ

`ItemService`ëŠ” ì±•í„° 4ì—ì„œ ìµíŒ `MemberService`ì˜ íŒ¨í„´ì„ ê·¸ëŒ€ë¡œ ë”°ë¦…ë‹ˆë‹¤.

| í•­ëª© | `MemberService` (ì±•í„° 4) | `ItemService` (ì±•í„° 5) |
|------|--------------------------|------------------------|
| í´ë˜ìŠ¤ `@Transactional` | `readOnly = true` | `readOnly = true` |
| ì €ì¥ ë©”ì„œë“œëª… | `join()` | `saveItem()` |
| ì €ì¥ ë©”ì„œë“œ ë°˜í™˜ íƒ€ì… | `Long` (ìƒì„±ëœ id ë°˜í™˜) | `void` |
| ë¹„ì¦ˆë‹ˆìŠ¤ ê²€ì¦ ë¡œì§ | ì¤‘ë³µ íšŒì› ê²€ì¦ (`validateDuplicateMember`) | ì—†ìŒ (ì—”í‹°í‹° ë‚´ë¶€ì˜ `removeStock`ì´ ë‹´ë‹¹) |
| DI ë°©ì‹ | `@RequiredArgsConstructor` | `@RequiredArgsConstructor` |
| ì¡°íšŒ ë©”ì„œë“œ ìˆ˜ | 2ê°œ (`findMembers`, `findOne`) | 2ê°œ (`findItems`, `findOne`) |

**ë°˜í™˜ íƒ€ì… ì°¨ì´ì˜ ì´ìœ :**

`MemberService.join()`ì´ `Long`ì„ ë°˜í™˜í•˜ëŠ” ì´ìœ ëŠ”, íšŒì› ê°€ì… í›„ ìƒì„±ëœ íšŒì› idë¥¼ í…ŒìŠ¤íŠ¸ë‚˜ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì¦‰ì‹œ í™œìš©í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
ë°˜ë©´ `ItemService.saveItem()`ì´ `void`ë¥¼ ë°˜í™˜í•˜ëŠ” ì´ìœ ëŠ”, í˜„ì¬ ì±•í„°ì—ì„œëŠ” ì €ì¥ í›„ idë¥¼ ì¦‰ì‹œ ì‚¬ìš©í•˜ëŠ” ë¡œì§ì´ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

**í•µì‹¬ ì •ë¦¬:**

`ItemService`ëŠ” **ì–‡ì€ ì„œë¹„ìŠ¤(Thin Service)** ê³„ì¸µì…ë‹ˆë‹¤.
ì‹¤ì§ˆì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ `Item` ì—”í‹°í‹° ë‚´ë¶€(`addStock`, `removeStock`)ì— ìˆê³ ,
ì„œë¹„ìŠ¤ëŠ” **íŠ¸ëœì­ì…˜ ê´€ë¦¬ + ë ˆí¬ì§€í† ë¦¬ ìœ„ì„** ë‘ ê°€ì§€ ì—­í• ë§Œ ë‹´ë‹¹í•©ë‹ˆë‹¤.

---

## 6. Best Practice ë° ì£¼ì˜ì‚¬í•­

### âœ… ìƒì† ë§¤í•‘ ì „ëµ ì„ íƒ ê¸°ì¤€

- **ë‹¨ìˆœ ì¡°íšŒê°€ ë§ê³  ì„±ëŠ¥ì´ ì¤‘ìš”í•œ ê²½ìš°** â†’ `SINGLE_TABLE` (ì´ ê°•ì˜ì˜ ì„ íƒ)
- **ë°ì´í„° ë¬´ê²°ì„±ì´ ì¤‘ìš”í•˜ê³  ìì‹ í…Œì´ë¸”ì„ ë…ë¦½ì ìœ¼ë¡œ ì¿¼ë¦¬í•´ì•¼ í•˜ëŠ” ê²½ìš°** â†’ `JOINED`
- **ì„œë¸Œíƒ€ì…ë³„ë¡œ ì™„ì „íˆ ë…ë¦½ì ì¸ ìš´ì˜ì´ í•„ìš”í•œ ê²½ìš°** â†’ `TABLE_PER_CLASS` (ê¶Œì¥ë˜ì§€ ì•ŠìŒ)

> ì •ë‹µì€ ì—†ìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ì˜ ê·œëª¨, ì¡°íšŒ íŒ¨í„´, íŒ€ì˜ ì—­ëŸ‰ì„ ê³ ë ¤í•˜ì—¬ ì„ íƒí•©ë‹ˆë‹¤.

### âœ… ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ ì ìš© ì›ì¹™

- **ë°ì´í„°ë¥¼ ì†Œìœ í•œ ì—”í‹°í‹°ì— ê´€ë ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œë¥¼ ë°°ì¹˜**í•©ë‹ˆë‹¤.
- ì„œë¹„ìŠ¤ì—ì„œ Setterë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ì—”í‹°í‹° ë‚´ë¶€ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì€ í”¼í•©ë‹ˆë‹¤.
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— **ê²€ì¦(validation)ì„ í¬í•¨**ì‹œì¼œ í•­ìƒ ì˜¬ë°”ë¥¸ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

### âš ï¸ `em.merge()` ì‚¬ìš© ì£¼ì˜

- `em.merge()`ëŠ” ì¤€ì˜ì† ì—”í‹°í‹°ì˜ **ëª¨ë“  í•„ë“œ**ë¥¼ DB ê°’ìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤.
- ì¼ë¶€ í•„ë“œë§Œ ë³€ê²½í•˜ê³  ì‹¶ì„ ë•Œ `merge()`ë¥¼ ì˜ëª» ì‚¬ìš©í•˜ë©´ **ì˜ë„í•˜ì§€ ì•Šì€ í•„ë“œê°€ nullë¡œ ì—…ë°ì´íŠ¸**ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë”°ë¼ì„œ ì‹¤ë¬´ì—ì„œëŠ” `merge()` ë³´ë‹¤ **ë³€ê²½ ê°ì§€(Dirty Checking)** ë°©ì‹ì´ ê¶Œì¥ë©ë‹ˆë‹¤.
- ìì„¸í•œ ë‚´ìš©ì€ ì±•í„° 7ì—ì„œ ë‹¤ë£¹ë‹ˆë‹¤.

### âœ… ì»¤ìŠ¤í…€ ì˜ˆì™¸ ì„¤ê³„ ì›ì¹™

- ë„ë©”ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ìœ„ë°˜ ì˜ˆì™¸ëŠ” `RuntimeException`ì„ ìƒì†í•˜ì—¬ **Unchecked Exception**ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
- `@Transactional`ì˜ ìë™ ë¡¤ë°± ë™ì‘ê³¼ ì¼ì¹˜ì‹œí‚µë‹ˆë‹¤.
- ìƒì„±ìë¥¼ ì˜¤ë²„ë¡œë”©í•˜ì—¬ ì˜ˆì™¸ ì²´ì´ë‹(`Throwable cause`)ì„ ì§€ì›í•©ë‹ˆë‹¤.

### âœ… `@Transactional(readOnly = true)` ì „ëµ

- í´ë˜ìŠ¤ ë ˆë²¨ì— `readOnly = true`ë¥¼ ê¸°ë³¸ ì„¤ì •í•©ë‹ˆë‹¤.
- ì“°ê¸° ë©”ì„œë“œ(`saveItem`)ì—ë§Œ `@Transactional`ì„ ê°œë³„ ì˜¤ë²„ë¼ì´ë“œí•©ë‹ˆë‹¤.
- ì´ íŒ¨í„´ì„ í†µí•´ ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ì˜ ì„±ëŠ¥ ìµœì í™”(flush ìƒëµ, DB ë³µì œ í™˜ê²½ì—ì„œ ì½ê¸° DB ì‚¬ìš© ë“±)ë¥¼ ì±™ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## 7. ë¶€ë¡

### 7.1 í•µì‹¬ ìš©ì–´ ì •ë¦¬

| ìš©ì–´ | ì„¤ëª… |
|------|------|
| **SINGLE_TABLE ì „ëµ** | JPA ìƒì† ë§¤í•‘ì—ì„œ ë¶€ëª¨ì™€ ëª¨ë“  ìì‹ì˜ ì»¬ëŸ¼ì„ í•˜ë‚˜ì˜ í…Œì´ë¸”ì— í†µí•©í•˜ëŠ” ì „ëµ |
| **DiscriminatorColumn** | SINGLE_TABLE ì „ëµì—ì„œ í–‰ì˜ íƒ€ì…ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ì»¬ëŸ¼ |
| **ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´** | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì„œë¹„ìŠ¤ê°€ ì•„ë‹Œ ì—”í‹°í‹° ë‚´ë¶€ì— ë°°ì¹˜í•˜ëŠ” ì•„í‚¤í…ì²˜ íŒ¨í„´ |
| **íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´** | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì„œë¹„ìŠ¤ ê³„ì¸µ(ìŠ¤í¬ë¦½íŠ¸)ì— ì§‘ì¤‘ì‹œí‚¤ëŠ” íŒ¨í„´ |
| **ì¤€ì˜ì† ì—”í‹°í‹°** | ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ëœ ìƒíƒœì˜ ì—”í‹°í‹° â€” idëŠ” ìˆìœ¼ë‚˜ JPAê°€ ë³€ê²½ì„ ì¶”ì í•˜ì§€ ì•ŠìŒ |
| **em.persist()** | ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡í•˜ëŠ” JPA ë©”ì„œë“œ |
| **em.merge()** | ì¤€ì˜ì† ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³‘í•©í•˜ëŠ” JPA ë©”ì„œë“œ |
| **ì˜ˆì™¸ ì²´ì´ë‹** | ì˜ˆì™¸ ìƒì„± ì‹œ ì›ì¸(cause)ì´ ëœ ë‹¤ë¥¸ ì˜ˆì™¸ë¥¼ í•¨ê»˜ í¬í•¨ì‹œì¼œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ë¥¼ ì´ì–´ì£¼ëŠ” ê¸°ë²• |
| **Unchecked Exception** | `RuntimeException`ì„ ìƒì†í•œ ì˜ˆì™¸ â€” ì»´íŒŒì¼ëŸ¬ê°€ ì²˜ë¦¬ë¥¼ ê°•ì œí•˜ì§€ ì•ŠìŒ |

---

### 7.2 ì–´ë…¸í…Œì´ì…˜ ì •ë¦¬

| ì–´ë…¸í…Œì´ì…˜ | íŒ¨í‚¤ì§€ | ì—­í•  |
|-----------|--------|------|
| `@Inheritance(strategy = ...)` | `jakarta.persistence` | JPA ìƒì† ë§¤í•‘ ì „ëµ ì„ íƒ |
| `@DiscriminatorColumn(name = "dtype")` | `jakarta.persistence` | êµ¬ë¶„ ì»¬ëŸ¼ ì§€ì • (ë¶€ëª¨ ì—”í‹°í‹°ì— ì„ ì–¸) |
| `@DiscriminatorValue("B")` | `jakarta.persistence` | ìì‹ ì—”í‹°í‹°ì˜ êµ¬ë¶„ê°’ ì§€ì • |
| `@Transactional(readOnly = true)` | `org.springframework.transaction` | ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ (flush ìµœì í™”) |
| `@RequiredArgsConstructor` | `lombok` | `final` í•„ë“œë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ê°–ëŠ” ìƒì„±ì ìë™ ìƒì„± |
| `@Repository` | `org.springframework.stereotype` | ì˜ˆì™¸ë¥¼ ìŠ¤í”„ë§ DataAccessExceptionìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë¹ˆ ë“±ë¡ |
| `@Service` | `org.springframework.stereotype` | ì„œë¹„ìŠ¤ ê³„ì¸µ ë¹ˆ ë“±ë¡ |

---

### 7.3 í•™ìŠµ í™•ì¸ ì§ˆë¬¸

1. JPA ìƒì† ë§¤í•‘ 3ê°€ì§€ ì „ëµì˜ ì´ë¦„ê³¼ ê° ì „ëµì´ ìƒì„±í•˜ëŠ” DB í…Œì´ë¸” êµ¬ì¡°ë¥¼ ì„¤ëª…í•˜ì„¸ìš”.
2. `SINGLE_TABLE` ì „ëµì—ì„œ `@DiscriminatorColumn`ê³¼ `@DiscriminatorValue`ê°€ ê°ê° ì–´ëŠ ì—”í‹°í‹°ì— ì„ ì–¸ë˜ê³ , ì–´ë–¤ ì—­í• ì„ í•˜ëŠ”ì§€ ì„¤ëª…í•˜ì„¸ìš”.
3. ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ê³¼ íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´ì˜ ì°¨ì´ë¥¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”.
4. `removeStock()`ì—ì„œ ì¬ê³  ì°¨ê° ì „ì— `restStock` ë³€ìˆ˜ë¥¼ ë¨¼ì € ê³„ì‚°í•˜ê³ , ê·¸ í›„ ìŒìˆ˜ ê²€ì¦ì„ í•˜ëŠ” ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?
5. `NotEnoughStockException`ì´ `Exception`ì´ ì•„ë‹Œ `RuntimeException`ì„ ìƒì†í•˜ëŠ” ì´ìœ  ë‘ ê°€ì§€ë¥¼ ì„¤ëª…í•˜ì„¸ìš”.
6. `ItemRepository.save()`ì—ì„œ `em.persist()`ì™€ `em.merge()`ë¥¼ ë¶„ê¸°í•˜ëŠ” ê¸°ì¤€ì€ ë¬´ì—‡ì´ê³ , ê° ë©”ì„œë“œê°€ ì‚¬ìš©ë˜ëŠ” ìƒí™©ì€ ì–´ë–»ê²Œ ë‹¤ë¥¸ê°€ìš”?

---

### 7.4 ë‹¤ìŒ ì±•í„° ì˜ˆê³  â€” ì±•í„° 6: ì£¼ë¬¸ ë„ë©”ì¸ ê°œë°œ

ì±•í„° 6ì—ì„œëŠ” **ì£¼ë¬¸(Order)** ë„ë©”ì¸ì„ ê°œë°œí•©ë‹ˆë‹¤.
ì±•í„° 5ê¹Œì§€ êµ¬í˜„í•œ íšŒì›(Member)ê³¼ ìƒí’ˆ(Item)ì„ ì—°ê²°í•˜ëŠ” í•µì‹¬ ë„ë©”ì¸ìœ¼ë¡œ,
ë‹¤ìŒ ê°œë…ë“¤ì´ ìƒˆë¡­ê²Œ ë“±ì¥í•©ë‹ˆë‹¤:

| ê°œë… | ì„¤ëª… |
|------|------|
| **ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì„œë“œ** | ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ í•œ ë²ˆì˜ í˜¸ì¶œë¡œ ì–‘ìª½ì— ì„¤ì •í•˜ëŠ” íŒ¨í„´ |
| **ì£¼ë¬¸ ìƒì„± íŒ©í† ë¦¬ ë©”ì„œë“œ** | `Order.createOrder()` â€” ë³µì¡í•œ ì—”í‹°í‹° ìƒì„± ë¡œì§ì„ ìº¡ìŠí™” |
| **ì£¼ë¬¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§** | ì£¼ë¬¸ ì·¨ì†Œ, ì „ì²´ ê°€ê²© ê³„ì‚° (`getTotalPrice`) |
| **ë™ì  ì¿¼ë¦¬** | ê²€ìƒ‰ ì¡°ê±´ì— ë”°ë¼ ì¿¼ë¦¬ê°€ ë‹¬ë¼ì§€ëŠ” `OrderSearch` ì²˜ë¦¬ |

ì±•í„° 4Â·5ì—ì„œ ìŒ“ì€ ê³„ì¸µí˜• ì•„í‚¤í…ì²˜ì™€ ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ì´ ì±•í„° 6ì—ì„œ ë³¸ê²©ì ìœ¼ë¡œ ë¹›ì„ ë°œí•©ë‹ˆë‹¤.
